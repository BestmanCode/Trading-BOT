#!/bin/bash

start()
{
  echo Starting TradingBot...
  cd src
  python3 main.py & echo $! > pid.txt
}

stop()
{
  echo Stopping TradingBot...
  cd src
  cat pid.txt | xargs kill
  rm pid.txt
}

close_positions()
{
  echo Starting TradingBot to close positions...
  cd src
  python3 main.py -c &
}

install_deps()
{
  echo Installing dependencies...
  pip install -r requirements.txt
}

test()
{
  echo Running unit test with pytest...
  install_deps
  sphinx-build -b dummy doc doc/_build
  pytest
}

start_docker()
{
  echo Starting TradingBot in a Docker container...
  mkdir -p /home/$USER/.TradingBot/log
  docker run -dit --rm --name dkr_trading_bot -v /home/alberto/workspace/TradingBot:/app -v /home/$USER/.TradingBot/log:/root/.TradingBot/log python:3 /bin/bash app/run_docker.sh
}

test_docker()
{
  echo Running unit test with pytest in a Docker container...
  echo Testing against Python 3.4...
  docker run -it --rm -v $(pwd):/app python:3.4 /bin/bash -cx "cd app && ./trading_bot_ctl test"
  echo Testing against Python 3.5...
  docker run -it --rm -v $(pwd):/app python:3.5 /bin/bash -cx "cd app && ./trading_bot_ctl test"
  echo Testing against Python 3.6...
  docker run -it --rm -v $(pwd):/app python:3.6 /bin/bash -cx "cd app && ./trading_bot_ctl test"
  echo Testing against Python 3 latest...
  docker run -it --rm -v $(pwd):/app python:3 /bin/bash -cx "cd app && ./trading_bot_ctl test"
}

case $1 in
  start|stop|close_positions|install_deps|test|test_docker|start_docker) "$1" ;;
esac
